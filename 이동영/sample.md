##NAT ( Network Address Translation, 네트워크 주소 변환 )
- 네트워크 세계에서 자신을 구별하기위한 식별자가 IP
- private IP는 다른 네트워크에서 통용되지 않는다.
- 그래서 다른 네트워크와 통신을 하기 위해서는 public IP가 필요하다.
- NAT는 private IP를 public IP로 1 대 1 대응시켜서 변환하는 장치를 말한다.
- IP 주소를 재기록 하면서 라우터를 통해 네트워크 트래픽을 주고받는 매커니즘이다.
- public IP는 인터넷에 접근할 때 부여되고 사용되지 않을 경우 다른사람에게 다시 공유되는 방식으로 돌고돈다.

- NAT의 역할
  - 사설 IP주소를 공인 IP 주소로 변환하는 작업
  - 내부 네트워크의 여러 기기가 하나의 공인 IP를 공유할 수 있게 해준다.
    - 집 컴퓨터, 스마트폰, 태블릿 -> 여러 사설 IP가 하나의 공인 IP로 변환되어 인터넷과 통신할 수 있게 해준다.

- 동적 IP 할당 방식
  - 사용자가 인터넷에 접속하면 ISP(인터넷 서비스 제공자)로부터 임시 공인 IP를 할당받는다.
  - 접속을 종료하면 그 IP주소는 pool로 돌아가서 다른사용자에게 할당될 수 있게 된다.

- WebRTC는 p2p 통신을 하는데 그럼 총 2개의 public IP가 필요하다. -> 문제는 public IP를 할당받을 때마다. 주소가 바뀌어서(동적으로 할당받아서) 
동일한 public IP로 통신할 수 없는 문제가 발생한다. -> 이 문제를 해결하기 위해 STUN, TURN 서버를 사용할 수 있다.

네트워크 통신 중재자, 교환원


##STUN( Session Traversal Utilities for NAT )
- 쉽게말해서 공인 IP주소를 발견하도록 돕는 기술

###STUN의 동작
1. 클라이언트가 STUN서버에 요청을 보냄
2. NAT가 이 요청을 변환하여 공인 IP와 포트를 할당
3. STUN서버에서 자신이 받은 요청의 출발지(공인IP)를 확인
4. 이 정보를 클라이언트에게 응답으로 전송

###STUN의 한계
- Symmetric NAT 환경에서는 신뢰할 수 없다.
- NAT바인딩이 변경되면 다시 요청 필요
- 일부 방화벽에서 막힐 수 있다.

이러한 한계점 때문에 TURN 서버가 필요하다.


##TURN
- NAT보안정책이 너무 엄격하거나, NAT 바인딩을 성공적으로 생성할 수 없을때 TURN을 사용한다.
- 중계서버를 통해 우회통신을 제공한다.

###TURN의 동작
1. 클라이언트에서 TURN서버에 자원 할당을 요청
2. 서버에서 클라이언트를 위한 임시 주소를 할당
3. 클라이언트에서 임시주소를 통해 다른 클라이언트와 통신

###TURN을 통한 데이터 전송
1. 클라이언트에서 데이터를 TURN서버에 전달
2. TURN 서버에서 데이터를 업로드
3. 다른 클라이언트에서 TURN서버를 통해 데이터를 다운로드 

TURN은 가장 확실하게 연결할 수 있는 방식이지만 높은 리소스 사용으로 ICE 프로토콜에서 가장 후순위로 배정된다.

##ICE( Interactive Connectivity Establishment )
- 최적의 경로를 찾아서 두 Peer를 연결해 주는 역할
- TURN, STUN을 사용해서 최적의 경로를 찾을 수 있도록 도와주는 프레임워크이다.
- 모든 단말(네트워크)는 환경이 달라서 Peer to Peer 연결에서 항상 동일하게 연결되지 않는다. 예를 들면 방화벽이 있는 환경에서는 방화벽을 통과해야하고, 대부분의 기기들은 사설 네트워크 안에 있어서 서로 연결이 불가능하다.
- 가능한 모든 연결 경로를 시도하고, 그중 가장 최적의 경로를 찾아 자동으로 선택

###ICE의 동작
- 후보군 수집
1. HOST Candidate
  - 장치의 실제 로컬 IP주소와 포트
  - NAT 환경에서는 사용하기 어려움
2. Reflexive Candidate (STUN)
  - NAT 환경의 공인 IP주소와 포트
  - STUN서버를 통해 자신의 공인 IP주소를 확인
3. Relay Candidate (TURN)
  - TURN서버의 IP주소와 포트
  - 직접 연결(HOST, STUN 방식)이 모두 실패할 경우 사용하는 우회 경로

- 후보 교환
  - 수집된 후보들을 시그널링 서버를통해 상대방과 교환
  - SDP에 후보정보를 포함하여 전달

- 연결 테스트
  - 각 후보군의 우선순위에 따라서 연결테스트를 진행
  - 1. Host-to-Host 
  - 2. Host-to-Reflexive ( STUN 사용 )
  - 3. Relay-to-Relay ( TURN 사용 )

- 최적의 경로 선택
  - 성공한 연결중 가장 효율적인 방식을 사용 -> TURN 방식은 자원 소모가 커서 가장 후순위로 연결된다.

- TURN방식이 자원을 많이 사용하는 이유
  - P2P직접연결
    - 100MB의 파일을 전송할 때 클라이언트끼리 직접 교환해서 서버를 거치지 않는다.
    - 서버는 트래픽처리를 하지 않음
    - 오직 초기 연결만 서버가 관여한다.
  - TURN 방식
    - A가 서버에 100MB의 파일을 업로드
    - 서버가 B에게 100MB의 파일을 다운로드
    - 서버에서는 총 200MB의 트래픽 처리가 발생

